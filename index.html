<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CIBORG347 | Presupuesto PDF</title>
  <meta name="description" content="Generador de presupuesto PDF para celular. Completar datos, generar, descargar y compartir PDF." />
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root{
      --bg:#070b12;
      --panel:#0f1624;
      --line:#243149;
      --text:#eef4ff;
      --muted:#9eb0c9;
      --accent:#00d4ff;
      --accent2:#7c3aed;
      --ok:#22c55e;
      --warn:#f59e0b;
      --err:#ef4444;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(0,212,255,.12), transparent 55%),
        radial-gradient(900px 600px at 100% 0%, rgba(124,58,237,.14), transparent 55%),
        #070b12;
      color:var(--text);
      padding:10px;
    }
    .app{
      max-width:820px;
      margin:0 auto;
      display:grid;
      gap:12px;
    }
    .card{
      background:linear-gradient(180deg, rgba(17,23,36,.92), rgba(12,17,28,.92));
      border:1px solid rgba(38,52,76,.9);
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 12px 32px rgba(0,0,0,.28);
      backdrop-filter: blur(6px);
    }
    .head{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px;
      border-bottom:1px solid rgba(38,52,76,.8);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
    }
    .head img{
      width:44px;height:44px;border-radius:10px;object-fit:cover;border:1px solid #2b3a55;background:#0b111d
    }
    .head .t strong{display:block;font-size:.96rem;line-height:1.15}
    .head .t span{display:block;font-size:.78rem;color:var(--muted);margin-top:2px}

    .body{padding:12px;display:grid;gap:10px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:grid;gap:6px}
    .field label{
      font-size:.78rem;
      font-weight:700;
      color:#d8e4f6;
      letter-spacing:.2px;
    }
    .field input,.field textarea{
      width:100%;
      border-radius:10px;
      border:1px solid #2b3850;
      background:#0b111d;
      color:var(--text);
      padding:11px 12px;
      outline:none;
      font:inherit;
      font-size:.95rem;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .field textarea{
      min-height:95px;
      resize:vertical;
      line-height:1.35;
    }
    .field input:focus,.field textarea:focus{
      border-color:#3b82f6;
      box-shadow:0 0 0 3px rgba(59,130,246,.14);
      background:#0d1421;
    }
    .help{
      font-size:.74rem;
      color:var(--muted);
      line-height:1.25;
    }

    .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .actions-3{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:8px;
    }
    .btn{
      border:none;
      border-radius:10px;
      min-height:44px;
      padding:10px;
      color:white;
      font-weight:800;
      font-size:.84rem;
      cursor:pointer;
      transition:transform .12s ease, opacity .12s ease, filter .12s ease, border-color .12s ease;
      letter-spacing:.2px;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:scale(.985)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .btn-green{background:linear-gradient(90deg,#16a34a,#22c55e)}
    .btn-dark{background:#0f1625;border:1px solid #2a3550;color:#e6efff}

    .status{
      border-top:1px solid rgba(38,52,76,.8);
      padding:10px 12px;
      font-size:.82rem;
      color:#d8e4f6;
      min-height:41px;
      display:flex;
      align-items:center;
      background:rgba(255,255,255,.01);
    }
    .status.ok{color:#bbf7d0}
    .status.warn{color:#fde68a}
    .status.err{color:#fecaca}

    .brand-site{
      margin-top:2px;
      font-size:.78rem;
      color:#b9c9e1;
      word-break:break-word;
    }

    .preview{display:none}
    .preview.show{display:block}
    .preview .pbody{
      padding:10px;
      background:#0b111b;
    }
    .sheet{
      border:1px solid #263148;
      border-radius:12px;
      background:#0d1522;
      padding:12px;
      display:grid;
      gap:8px;
      position:relative;
      overflow:hidden;
    }
    .sheet::before{
      content:"";
      position:absolute;inset:0;
      background:url("https://iili.io/qFQyNae.png") center/58% no-repeat;
      opacity:.11;
      pointer-events:none;
      filter:saturate(1.15) contrast(1.05);
    }
    .sheet::after{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(5,9,16,.18), rgba(5,9,16,.08));
      pointer-events:none;
    }
    .sheet > *{position:relative}
    .s-top{
      display:grid;
      grid-template-columns:56px 1fr;
      gap:10px;
      align-items:center;
      border-bottom:1px solid rgba(37,49,71,.85);
      padding-bottom:8px;
    }
    .s-top img{
      width:56px;height:56px;border-radius:10px;object-fit:cover;border:1px solid #27344b;background:#0b111d;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .s-top .k{font-size:.68rem;color:#9ab0cd}
    .s-top .v{font-size:1.05rem;color:#8feaff;font-weight:900;line-height:1.05}
    .s-meta{font-size:.72rem;color:#c1d1e8;display:flex;flex-wrap:wrap;gap:8px}
    .box{
      border:1px solid rgba(38,49,72,.75);
      border-radius:10px;
      background:rgba(10,16,28,.42);
      padding:10px;
    }
    .box .lab{
      font-size:.68rem;
      color:#cba1ff;
      font-weight:800;
      margin-bottom:4px;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .box .val{
      font-size:.9rem;
      color:#edf4ff;
      word-break:break-word;
    }
    .box .total{color:#9df3bb;font-weight:900}
    .preview-list{
      padding-left:16px;
      display:grid;
      gap:3px;
      color:#cfddf0;
      font-size:.8rem;
    }
    .foot-note{
      border-top:1px solid rgba(38,49,72,.9);
      color:#c7d6e8;
      font-size:.75rem;
      line-height:1.35;
      background:rgba(9,14,24,.22);
      border-radius:8px;
      padding:8px;
    }
    .contact-row{
      display:flex;
      align-items:center;
      gap:6px;
      margin-top:4px;
      flex-wrap:wrap;
    }
    .contact-row .ico{
      width:15px;height:15px;display:inline-flex;align-items:center;justify-content:center;
      opacity:.95; flex:0 0 auto;
    }
    .contact-row img{
      width:15px;height:15px;object-fit:contain;display:block;
    }
    .signature{
      margin-top:6px;
      text-align:center;
      color:#95a9c4;
      font-size:.72rem;
      letter-spacing:.35px;
      text-transform:uppercase;
    }

    @media (max-width:700px){
      .grid-2,.actions,.actions-3{grid-template-columns:1fr}
      .field input,.field textarea{font-size:16px}
    }
  </style>
</head>
<body>
  <div class="app">
    <section class="card">
      <div class="head">
        <img src="https://iili.io/qFQyNae.png" alt="CIBORG347">
        <div class="t">
          <strong>CIBORG347 | Presupuesto PDF</strong>
          <span>Generar, descargar y compartir PDF</span>
          <div class="brand-site">CIBORG347OFICIAL.ONRENDER.COM</div>
        </div>
      </div>

      <div class="body">
        <div class="grid-2">
          <div class="field">
            <label for="fecha">Fecha</label>
            <input id="fecha" type="text" value="23/02/2026">
          </div>
          <div class="field">
            <label for="numero">Número de presupuesto</label>
            <input id="numero" type="text" value="C347-001">
          </div>
        </div>

        <div class="field">
          <label for="cliente">Nombre del cliente</label>
          <input id="cliente" type="text" placeholder="Ej: Nombre del cliente">
        </div>

        <div class="field">
          <label for="servicio">Servicio / Presupuesto</label>
          <input id="servicio" type="text" value="Creación de sitio web profesional full responsive">
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="precio">Inversión</label>
            <input id="precio" type="text" value="$ 120.000 ARS">
          </div>
          <div class="field">
            <label for="entrega">Tiempo estimado (opcional)</label>
            <input id="entrega" type="text" value="A coordinar según contenido final">
          </div>
        </div>

        <div class="field">
          <label for="incluye">Qué incluye (1 ítem por línea)</label>
          <textarea id="incluye">Diseño personalizado
Versión responsive (celular y PC)
Botón WhatsApp
Carga inicial de contenido
Ajustes finales
Entrega lista para usar</textarea>
          <div class="help">Escribí una línea por ítem. El PDF se arma con estos puntos.</div>
        </div>

        <div class="field">
          <label for="detalle">Detalle / observaciones</label>
          <textarea id="detalle">Se abona una vez entregado el sitio / transferencia o MP. Esta propuesta puede ajustarse según cambios de alcance, contenido o funcionalidades solicitadas.</textarea>
        </div>

        <div class="actions">
          <button id="btnGenerar" class="btn btn-primary">Generar PDF</button>
          <button id="btnCompartir" class="btn btn-green">Compartir PDF</button>
        </div>

        <div class="actions-3">
          <button id="btnDescargar" class="btn btn-dark">Descargar PDF</button>
          <button id="btnPreview" class="btn btn-dark">Mostrar vista previa</button>
          <button id="btnActualizar" class="btn btn-dark">Actualizar vista</button>
        </div>
      </div>

      <div id="status" class="status">Listo. Completá los datos y tocá Generar PDF.</div>
    </section>

    <section id="preview" class="card preview">
      <div class="pbody">
        <div class="sheet">
          <div class="s-top">
            <img src="https://iili.io/qFQyNae.png" alt="Logo">
            <div>
              <div class="k mono">PRESUPUESTO FORMAL</div>
              <div class="v mono">CIBORG347</div>
              <div class="s-meta mono">
                <span>FECHA: <b id="pvFecha">-</b></span>
                <span>NRO: <b id="pvNumero">-</b></span>
              </div>
            </div>
          </div>

          <div class="box">
            <div class="lab mono">Nombre</div>
            <div class="val mono" id="pvCliente">-</div>
          </div>

          <div class="box">
            <div class="lab mono">Servicio</div>
            <div class="val mono" id="pvServicio">-</div>
          </div>

          <div class="box">
            <div class="lab mono">Inversión</div>
            <div class="val total mono" id="pvPrecio">-</div>
          </div>

          <div class="box">
            <div class="lab mono">Qué incluye</div>
            <ul id="pvIncluye" class="preview-list mono"></ul>
          </div>

          <div class="box">
            <div class="lab mono">Detalle</div>
            <div class="val mono" id="pvDetalle">-</div>
          </div>

          <div class="foot-note mono">
            <div><b>Modalidad de pago:</b> Se abona una vez entregado el sitio / transferencia o MP</div>
            <div><b>Modalidad de pago:</b> Pago contra entrega del sitio final</div>
            <div class="contact-row"><span class="ico"><img src="https://cdn.simpleicons.org/whatsapp/25D366" alt="WhatsApp"></span><span><b>WhatsApp:</b> <span id="pvWa">1164499481</span></span></div>
            <div class="contact-row"><span class="ico"><img src="https://cdn.simpleicons.org/instagram/E4405F" alt="Instagram"></span><span><b>Instagram:</b> <span id="pvIg">@ciborg347</span></span></div>
            <div class="contact-row"><span class="ico"><img src="https://cdn.simpleicons.org/gmail/EA4335" alt="Email"></span><span><b>Email:</b> <span id="pvMail">ciborg347@gmail.com</span></span></div>
            <div class="contact-row"><span class="ico"><img src="https://cdn.simpleicons.org/googlechrome/4285F4" alt="Web"></span><span><b>Web:</b> <span id="pvWeb">CIBORG347OFICIAL.ONRENDER.COM</span></span></div>
            <div class="signature">CIBORG347 // DISEÑO QUE CONVIERTE VISITAS EN CLIENTES</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    (function () {
      const { jsPDF } = window.jspdf;
      const $ = (id) => document.getElementById(id);

      const els = {
        fecha: $("fecha"),
        numero: $("numero"),
        cliente: $("cliente"),
        servicio: $("servicio"),
        precio: $("precio"),
        entrega: $("entrega"),
        incluye: $("incluye"),
        detalle: $("detalle"),
        btnGenerar: $("btnGenerar"),
        btnCompartir: $("btnCompartir"),
        btnDescargar: $("btnDescargar"),
        btnPreview: $("btnPreview"),
        btnActualizar: $("btnActualizar"),
        status: $("status"),
        preview: $("preview"),
        pvFecha: $("pvFecha"),
        pvNumero: $("pvNumero"),
        pvCliente: $("pvCliente"),
        pvServicio: $("pvServicio"),
        pvPrecio: $("pvPrecio"),
        pvIncluye: $("pvIncluye"),
        pvDetalle: $("pvDetalle"),
        pvWa: $("pvWa"),
        pvIg: $("pvIg"),
        pvMail: $("pvMail"),
        pvWeb: $("pvWeb")
      };

      const BRAND_LOGO = "https://iili.io/qFQyNae.png";
      const BRAND_WA = "1164499481";
      const BRAND_IG = "@ciborg347";
      const BRAND_MAIL = "ciborg347@gmail.com";
      const BRAND_WEB = "CIBORG347OFICIAL.ONRENDER.COM";
      const BRAND_FIRMA = "CIBORG347 // DISEÑO QUE CONVIERTE VISITAS EN CLIENTES";

      const ICON_WA = "https://cdn.simpleicons.org/whatsapp/25D366";
      const ICON_IG = "https://cdn.simpleicons.org/instagram/E4405F";
      const ICON_MAIL = "https://cdn.simpleicons.org/gmail/EA4335";
      const ICON_WEB = "https://cdn.simpleicons.org/googlechrome/4285F4";

      let previewVisible = false;
      let pdfBlobCache = null;
      let pdfNameCache = "presupuesto-ciborg347.pdf";

      let logoDataUrlCache = null;
      let iconWaDataUrlCache = null;
      let iconIgDataUrlCache = null;
      let iconMailDataUrlCache = null;
      let iconWebDataUrlCache = null;

      function setStatus(msg, type) {
        els.status.className = "status" + (type ? " " + type : "");
        els.status.textContent = msg;
      }

      function safe(v, fallback = "-") {
        const s = String(v || "").trim();
        return s || fallback;
      }

      function getBullets() {
        return String(els.incluye.value || "")
          .split(/\n+/)
          .map(x => x.trim())
          .filter(Boolean);
      }

      function getData() {
        return {
          fecha: safe(els.fecha.value, "DD/MM/AAAA"),
          numero: safe(els.numero.value, "C347-001"),
          cliente: safe(els.cliente.value, "Nombre del cliente"),
          servicio: safe(els.servicio.value, "Servicio"),
          precio: safe(els.precio.value, "$ 0"),
          entrega: safe(els.entrega.value, "-"),
          incluye: getBullets(),
          detalle: safe(els.detalle.value, "-")
        };
      }

      function invalidatePdf() {
        pdfBlobCache = null;
      }

      function updatePreview() {
        const d = getData();
        els.pvFecha.textContent = d.fecha;
        els.pvNumero.textContent = d.numero;
        els.pvCliente.textContent = d.cliente;
        els.pvServicio.textContent = d.servicio;
        els.pvPrecio.textContent = d.precio;
        els.pvDetalle.textContent = d.detalle;
        if (els.pvWa) els.pvWa.textContent = BRAND_WA;
        if (els.pvIg) els.pvIg.textContent = BRAND_IG;
        if (els.pvMail) els.pvMail.textContent = BRAND_MAIL;
        if (els.pvWeb) els.pvWeb.textContent = BRAND_WEB;

        els.pvIncluye.innerHTML = "";
        const items = d.incluye.length ? d.incluye : ["Detalle a definir"];
        items.slice(0, 8).forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          els.pvIncluye.appendChild(li);
        });
        if (previewVisible) setStatus("Vista previa actualizada.", "ok");
      }

      async function fetchAsDataUrl(url) {
        try {
          const res = await fetch(url, { mode: "cors" });
          if (!res.ok) throw new Error("No se pudo cargar recurso");
          const blob = await res.blob();
          return await new Promise((resolve, reject) => {
            const fr = new FileReader();
            fr.onload = () => resolve(fr.result);
            fr.onerror = reject;
            fr.readAsDataURL(blob);
          });
        } catch (e) {
          return null;
        }
      }

      async function loadBrandAssetsOnce() {
        if (!logoDataUrlCache) logoDataUrlCache = await fetchAsDataUrl(BRAND_LOGO);
        if (!iconWaDataUrlCache) iconWaDataUrlCache = await fetchAsDataUrl(ICON_WA);
        if (!iconIgDataUrlCache) iconIgDataUrlCache = await fetchAsDataUrl(ICON_IG);
        if (!iconMailDataUrlCache) iconMailDataUrlCache = await fetchAsDataUrl(ICON_MAIL);
        if (!iconWebDataUrlCache) iconWebDataUrlCache = await fetchAsDataUrl(ICON_WEB);

        return {
          logo: logoDataUrlCache,
          wa: iconWaDataUrlCache,
          ig: iconIgDataUrlCache,
          mail: iconMailDataUrlCache,
          web: iconWebDataUrlCache
        };
      }

      function mmTextBox(doc, x, y, w, h, label, value, opts = {}) {
        const {
          labelColor = [196,155,255],
          valueColor = [238,244,251],
          boldValue = false,
          maxLines = 2,
          fillColor = [11,16,32],
          fillOpacity = 0.28,
          borderColor = [39,49,73]
        } = opts;

        try {
          doc.saveGraphicsState();
          doc.setGState(new doc.GState({ opacity: fillOpacity }));
          doc.setFillColor(...fillColor);
          doc.setDrawColor(...borderColor);
          doc.roundedRect(x, y, w, h, 3, 3, "FD");
          doc.restoreGraphicsState();
        } catch (_) {
          doc.setFillColor(...fillColor);
          doc.setDrawColor(...borderColor);
          doc.roundedRect(x, y, w, h, 3, 3, "FD");
        }

        doc.setFont("courier", "bold");
        doc.setFontSize(7);
        doc.setTextColor(...labelColor);
        doc.text(label.toUpperCase(), x + 3, y + 5);

        doc.setFont("courier", boldValue ? "bold" : "normal");
        doc.setFontSize(8.2);
        doc.setTextColor(...valueColor);

        const lines = doc.splitTextToSize(String(value || "-"), w - 6).slice(0, maxLines);
        let yy = y + 10;
        lines.forEach(line => {
          doc.text(line, x + 3, yy);
          yy += 4.4;
        });
      }

      function drawIconTextRow(doc, x, y, iconDataUrl, fallbackGlyph, label, value, columnsWidth) {
        const iconSize = 4.2;
        let textX = x;

        if (iconDataUrl) {
          try {
            const format = iconDataUrl.includes("image/png") ? "PNG" : "JPEG";
            doc.addImage(iconDataUrl, format, x, y - 3.5, iconSize, iconSize, undefined, "FAST");
            textX = x + 5.5;
          } catch (_) {
            doc.setFont("helvetica", "bold");
            doc.setFontSize(8);
            doc.setTextColor(198,214,232);
            doc.text(fallbackGlyph, x, y);
            textX = x + 4.5;
          }
        } else {
          doc.setFont("helvetica", "bold");
          doc.setFontSize(8);
          doc.setTextColor(198,214,232);
          doc.text(fallbackGlyph, x, y);
          textX = x + 4.5;
        }

        doc.setFont("courier", "normal");
        doc.setFontSize(6.8);
        doc.setTextColor(198,214,232);
        const text = `${label}: ${value}`;
        const lines = doc.splitTextToSize(text, columnsWidth || 52).slice(0, 2);
        let ty = y;
        lines.forEach(line => {
          doc.text(line, textX, ty);
          ty += 3.7;
        });
      }

      async function buildPdfBlob() {
        const d = getData();
        setStatus("Generando PDF...", "warn");

        const doc = new jsPDF({ unit: "mm", format: "a4", compress: true });
        const assets = await loadBrandAssetsOnce();

        doc.setFillColor(8, 11, 18);
        doc.rect(0, 0, 210, 297, "F");

        doc.setFillColor(0, 212, 255); doc.rect(0, 0, 70, 3, "F");
        doc.setFillColor(124, 58, 237); doc.rect(70, 0, 70, 3, "F");
        doc.setFillColor(236, 72, 153); doc.rect(140, 0, 70, 3, "F");

        if (assets.logo) {
          try {
            doc.saveGraphicsState();
            doc.setGState(new doc.GState({ opacity: 0.20 }));
            doc.addImage(assets.logo, "PNG", 23, 66, 164, 164, undefined, "FAST");
            doc.restoreGraphicsState();

            doc.saveGraphicsState();
            doc.setGState(new doc.GState({ opacity: 0.08 }));
            doc.addImage(assets.logo, "PNG", 78, 6, 54, 54, undefined, "FAST");
            doc.restoreGraphicsState();
          } catch (_) {}
        }

        try {
          doc.saveGraphicsState();
          doc.setGState(new doc.GState({ opacity: 0.16 }));
          doc.setFillColor(9, 14, 24);
          doc.roundedRect(8, 8, 194, 281, 6, 6, "F");
          doc.restoreGraphicsState();
        } catch (_) {}

        const m = 12;
        let y = 10;

        try {
          doc.saveGraphicsState();
          doc.setGState(new doc.GState({ opacity: 0.20 }));
          doc.setFillColor(11,16,32);
          doc.setDrawColor(39,49,73);
          doc.roundedRect(m, y, 186, 24, 3, 3, "FD");
          doc.restoreGraphicsState();
        } catch (_) {}

        const logoBoxX = 81;
        const logoBoxW = 48;
        try {
          doc.saveGraphicsState();
          doc.setGState(new doc.GState({ opacity: 0.28 }));
          doc.setFillColor(11,16,32);
          doc.setDrawColor(39,49,73);
          doc.roundedRect(logoBoxX, y + 1, logoBoxW, 22, 3, 3, "FD");
          doc.restoreGraphicsState();
        } catch (_) {}

        if (assets.logo) {
          try { doc.addImage(assets.logo, "PNG", logoBoxX + 10, y + 2.2, 28, 19, undefined, "FAST"); } catch (_) {}
        }

        doc.setFont("courier", "normal");
        doc.setFontSize(8);
        doc.setTextColor(147,167,194);
        doc.text("PRESUPUESTO FORMAL", 12, y + 7);

        doc.setFont("courier", "normal");
        doc.setFontSize(8);
        doc.setTextColor(191,208,226);
        doc.text(`FECHA: ${d.fecha}`, 12, y + 13);
        doc.text(`NRO: ${d.numero}`, 12, y + 19);

        doc.setFont("courier", "bold");
        doc.setFontSize(10.5);
        doc.setTextColor(140,231,255);
        doc.text("CIBORG347", 198, y + 9, { align: "right" });

        doc.setFont("courier", "normal");
        doc.setFontSize(6.9);
        doc.setTextColor(185,206,231);
        doc.text(BRAND_WEB, 198, y + 16.3, { align: "right" });

        y += 30;
        doc.setDrawColor(39,49,73);
        doc.line(m, y, 210 - m, y);
        y += 4;

        const gap = 4;
        const half = (210 - m * 2 - gap) / 2;
        mmTextBox(doc, m, y, half, 17, "Nombre", d.cliente, { maxLines: 2, fillOpacity: 0.26 });
        mmTextBox(doc, m + half + gap, y, half, 17, "Inversión", d.precio, {
          valueColor: [152,245,178],
          boldValue: true,
          maxLines: 2,
          fillOpacity: 0.26
        });
        y += 20;

        mmTextBox(doc, m, y, 210 - m * 2, 17, "Servicio / Presupuesto", d.servicio, { maxLines: 2, fillOpacity: 0.22 });
        y += 20;

        mmTextBox(doc, m, y, 210 - m * 2, 15, "Tiempo estimado", d.entrega, { maxLines: 2, fillOpacity: 0.18 });
        y += 18;

        const incluyeH = 48;
        try {
          doc.saveGraphicsState();
          doc.setGState(new doc.GState({ opacity: 0.16 }));
          doc.setFillColor(11,16,32);
          doc.setDrawColor(39,49,73);
          doc.roundedRect(m, y, 210 - m * 2, incluyeH, 3, 3, "FD");
          doc.restoreGraphicsState();
        } catch (_) {
          doc.setFillColor(11,16,32);
          doc.setDrawColor(39,49,73);
          doc.roundedRect(m, y, 210 - m * 2, incluyeH, 3, 3, "FD");
        }

        doc.setFont("courier", "bold");
        doc.setFontSize(7);
        doc.setTextColor(196,155,255);
        doc.text("QUÉ INCLUYE", m + 3, y + 5);

        doc.setFont("courier", "normal");
        doc.setFontSize(7.7);
        doc.setTextColor(221,233,247);
        const bullets = d.incluye.length ? d.incluye : ["Detalle a definir"];
        let by = y + 11;
        const maxBulletLines = 7;
        let used = 0;
        for (const item of bullets) {
          if (used >= maxBulletLines) break;
          const lines = doc.splitTextToSize("• " + item, 210 - m * 2 - 8);
          for (const line of lines) {
            if (used >= maxBulletLines) break;
            doc.text(line, m + 4, by);
            by += 4.8;
            used++;
          }
        }
        y += incluyeH + 4;

        const detH = 28;
        try {
          doc.saveGraphicsState();
          doc.setGState(new doc.GState({ opacity: 0.10 }));
          doc.setFillColor(11,16,32);
          doc.roundedRect(m, y, 210 - m * 2, detH, 3, 3, "F");
          doc.restoreGraphicsState();
        } catch (_) {}
        doc.setDrawColor(39,49,73);
        doc.roundedRect(m, y, 210 - m * 2, detH, 3, 3, "S");

        doc.setFont("courier", "bold");
        doc.setFontSize(7);
        doc.setTextColor(221,233,247);
        doc.text("DETALLE / OBSERVACIONES", m + 3, y + 5);

        doc.setFont("courier", "normal");
        doc.setFontSize(7.3);
        doc.setTextColor(214,227,242);
        const detLines = doc.splitTextToSize(d.detalle, 210 - m * 2 - 6).slice(0, 4);
        let dy = y + 10;
        detLines.forEach(line => {
          doc.text(line, m + 3, dy);
          dy += 4.5;
        });
        y += detH + 5;

        doc.setDrawColor(39,49,73);
        doc.line(m, y, 210 - m, y);

        doc.setFont("courier", "bold");
        doc.setFontSize(7.1);
        doc.setTextColor(198,214,232);
        doc.text("MODALIDAD DE PAGO: Se abona una vez entregado el sitio / transferencia o MP", m, y + 5);
        doc.text("MODALIDAD DE PAGO: Pago contra entrega del sitio final", m, y + 9.6);

        const footerY = y + 15;

        try {
          doc.saveGraphicsState();
          doc.setGState(new doc.GState({ opacity: 0.12 }));
          doc.setFillColor(11,16,32);
          doc.setDrawColor(39,49,73);
          doc.roundedRect(m, footerY - 4.5, 210 - (m * 2), 17.5, 3, 3, "FD");
          doc.restoreGraphicsState();
        } catch (_) {}

        const totalW = 210 - (m * 2);
        const colW = totalW / 4;

        drawIconTextRow(doc, m + 2,            footerY, assets.wa,   "W", "WHATSAPP", BRAND_WA,   colW - 7);
        drawIconTextRow(doc, m + colW + 2,     footerY, assets.ig,   "I", "INSTAGRAM", BRAND_IG,  colW - 7);
        drawIconTextRow(doc, m + colW * 2 + 2, footerY, assets.mail, "M", "EMAIL", BRAND_MAIL,    colW - 7);
        drawIconTextRow(doc, m + colW * 3 + 2, footerY, assets.web,  "W", "WEB", BRAND_WEB,       colW - 7);

        doc.setDrawColor(39,49,73);
        doc.line(m, footerY + 14.5, 210 - m, footerY + 14.5);

        doc.setFont("courier", "normal");
        doc.setFontSize(6.8);
        doc.setTextColor(143,165,191);
        doc.text(BRAND_FIRMA, 105, footerY + 19.2, { align: "center" });

        const cleanClient = d.cliente
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/ñ/gi, "n")
          .replace(/[^\w\s-]/g, "")
          .trim()
          .replace(/\s+/g, "-")
          .toLowerCase() || "cliente";

        pdfNameCache = `presupuesto-ciborg347-${cleanClient}.pdf`;
        pdfBlobCache = doc.output("blob");

        setStatus("PDF generado correctamente.", "ok");
        return pdfBlobCache;
      }

      async function ensurePdf() {
        if (pdfBlobCache) return pdfBlobCache;
        return buildPdfBlob();
      }

      function setBusy(state) {
        [els.btnGenerar, els.btnCompartir, els.btnDescargar].forEach(b => b.disabled = !!state);
      }

      els.btnGenerar.addEventListener("click", async () => {
        setBusy(true);
        try {
          await buildPdfBlob();
        } catch (e) {
          console.error(e);
          setStatus("Error al generar PDF.", "err");
        } finally {
          setBusy(false);
        }
      });

      els.btnDescargar.addEventListener("click", async () => {
        setBusy(true);
        try {
          const blob = await ensurePdf();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = pdfNameCache || "presupuesto-ciborg347.pdf";
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 1200);
          setStatus("PDF descargado.", "ok");
        } catch (e) {
          console.error(e);
          setStatus("No se pudo descargar el PDF.", "err");
        } finally {
          setBusy(false);
        }
      });

      els.btnCompartir.addEventListener("click", async () => {
        setBusy(true);
        try {
          const blob = await ensurePdf();

          if (!navigator.share || typeof File === "undefined") {
            setStatus("Este dispositivo no soporta compartir archivos. Usá Descargar PDF.", "warn");
            setBusy(false);
            return;
          }

          const file = new File([blob], pdfNameCache || "presupuesto-ciborg347.pdf", { type: "application/pdf" });

          if (navigator.canShare && !navigator.canShare({ files: [file] })) {
            setStatus("Tu celu no permite compartir PDF directo. Usá Descargar PDF.", "warn");
            setBusy(false);
            return;
          }

          await navigator.share({
            title: "Presupuesto CIBORG347",
            text: "Te comparto el presupuesto en PDF.",
            files: [file]
          });

          setStatus("PDF compartido correctamente.", "ok");
        } catch (e) {
          if (e && e.name === "AbortError") {
            setStatus("Compartir cancelado.", "warn");
          } else {
            console.error(e);
            setStatus("No se pudo compartir el PDF.", "err");
          }
        } finally {
          setBusy(false);
        }
      });

      els.btnPreview.addEventListener("click", () => {
        previewVisible = !previewVisible;
        els.preview.classList.toggle("show", previewVisible);
        els.btnPreview.textContent = previewVisible ? "Ocultar vista previa" : "Mostrar vista previa";
        if (previewVisible) {
          updatePreview();
          setStatus("Vista previa activada.", "ok");
        } else {
          setStatus("Vista previa oculta.", "ok");
        }
      });

      els.btnActualizar.addEventListener("click", () => {
        updatePreview();
      });

      ["fecha","numero","cliente","servicio","precio","entrega","incluye","detalle"].forEach(id => {
        $(id).addEventListener("input", invalidatePdf);
        $(id).addEventListener("change", invalidatePdf);
      });

      updatePreview();
      setStatus("Listo. Diseño actualizado y PDF con formato tipo factura.", "ok");
    })();
  </script>
</body>
</html>
